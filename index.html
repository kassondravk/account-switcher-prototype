<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iQ Navigation Panel</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector-based icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inter font for the entire application -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styling for the page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F6F7F9;
            margin: 0;
            display: flex;
            justify-content: flex-start; /* Align content to the left */
            align-items: flex-start;
            min-height: 100vh;
        }

        /* --- Design System Color Placeholders (For clarity) --- */
        .bg-Web-Fill-Navigation-Default { background-color: #192129; }
        .text-Web-Text-Navigation-Default { color: #9ca3af; } /* Example: Gray-400 */
        .text-Web-Text-Navigation-Selected { color: #ffffff; } /* Example: White */
        .bg-Web-Fill-Navigation-Selected { background-color: #2D3943; }
        .border-Web-Border-Container-Primary { border-color: #4b5563; } /* Example: Gray-600 */
        .bg-Web-Text-Static-Inverse { background-color: #f9fafb; } /* Example: Gray-50 (for logo placeholder) */

        /* --- Minimal CSS for state transitions and overrides --- */
        .nav-item {
            transition: background-color 0.2s ease;
            min-height: 60px; /* Ensure items have enough height for two lines */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Hover state for navigation items */
        .nav-item:not([data-selected="true"]):hover {
            background-color: #252f3a; /* Hover background */
        }
        .nav-item:not([data-selected="true"]):hover .text-Web-Text-Navigation-Default {
            color: #d1d5db; /* Lighter gray text on hover */
        }
        .nav-item:not([data-selected="true"]):hover .icon-default {
            stroke: #d1d5db; /* Lighter gray icon on hover */
        }

        /* Selected state styling */
        .nav-item[data-selected="true"] {
            background-color: var(--bg-Web-Fill-Navigation-Selected, #2D3943); /* Selected background */
        }
        .nav-item[data-selected="true"] .text-Web-Text-Navigation-Default {
            color: var(--text-Web-Text-Navigation-Selected, #ffffff); /* Selected text color */
            font-weight: 600; /* Bolder text for selected item */
        }
        .nav-item[data-selected="true"] .icon-default {
            stroke: var(--text-Web-Text-Navigation-Selected, #ffffff); /* Selected icon color */
        }

        /* Default icon color */
        .nav-item .icon-default {
            stroke: var(--text-Web-Text-Navigation-Default, #9ca3af);
        }

        /* Account menu styling */
        .account-menu {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* User Profile Page specific styles */
        .profile-nav-item {
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .profile-nav-item.active, .profile-nav-item:hover {
            background-color: #2D3943;
            color: #ffffff;
        }
        
        #profileAccountListContainer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        /* Styles for the scrollable account switcher */
        #accountList, #profileAccountList {
            max-height: 300px; /* Set a max height to enable scrolling */
            overflow-y: auto; /* Show scrollbar when content overflows */
        }

        /* Custom scrollbar for account switcher to match the dark theme */
        #accountList::-webkit-scrollbar, #profileAccountList::-webkit-scrollbar {
            width: 8px;
        }
        #accountList::-webkit-scrollbar-track, #profileAccountList::-webkit-scrollbar-track {
            background: #2D3943;
        }
        #accountList::-webkit-scrollbar-thumb, #profileAccountList::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
            border: 2px solid #2D3943;
        }
        #accountList::-webkit-scrollbar-thumb:hover, #profileAccountList::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

    </style>
</head>
<body class="bg-white">

    <!-- Main App View -->
    <div id="mainAppView" class="flex">
        <div class="relative flex">
            <!-- Main navigation container -->
            <div id="mainNavContainer" class="w-20 h-screen pt-6 bg-Web-Fill-Navigation-Default flex flex-col items-center">
                <!-- Nav content is rendered here by JS -->
            </div>

            <!-- Platform Select Menu -->
            <div id="platformMenu" class="hidden absolute left-full ml-2 top-4 w-64 bg-[#192129] text-white rounded-md account-menu z-10">
                 <div class="px-4 py-3 border-b border-gray-700"><h3 class="text-lg font-semibold text-center">Select Platform</h3></div>
                 <div id="platformList" class="py-2 border-b border-gray-700"></div>
                 <div class="p-2"><button id="platformContinueButton" class="w-full bg-blue-600 text-white rounded py-2 hover:bg-blue-700">Continue</button></div>
            </div>

            <!-- Account Menu (Initially Hidden) -->
            <div id="accountMenu" class="hidden absolute left-full ml-2 bottom-4 w-72 bg-[#192129] text-white rounded-md account-menu z-10 flex flex-col">
                <div class="px-4 py-3 border-b border-gray-700">
                    <h3 class="text-lg font-semibold text-center">Select Account</h3>
                    <div class="relative mt-2">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                        </span>
                        <input type="text" id="accountSearchInput" placeholder="Search accounts..." class="w-full bg-[#2D3943] text-white rounded py-1 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Currently Selected Account -->
                <div id="currentAccountDisplay" class="p-3 bg-black bg-opacity-20 border-b border-gray-700">
                    <!-- Current user info rendered here -->
                </div>
                <div class="flex-1 min-h-0">
                    <div id="accountList" class="py-2"></div>
                    <div id="accountListNoMatch" class="hidden text-center py-4 text-gray-500 text-sm">No match found</div>
                </div>
                <div class="border-t border-gray-700 py-2"><a href="#" id="accountInfoLink" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Account Information</a><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Live Support</a><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Help Center</a></div>
                <div class="border-t border-gray-700 py-2"><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Log Out</a></div>
            </div>
        </div>
    </div>

    <!-- User Profile View (Initially Hidden) -->
    <div id="userProfileView" class="hidden w-full h-screen">
        <div class="flex h-full">
            <!-- Profile Navigation -->
            <div class="w-64 h-full bg-Web-Fill-Navigation-Default text-white flex flex-col">
                <div id="backToApp" class="px-6 py-4 border-b border-gray-700 cursor-pointer"><div class="text-2xl font-bold flex items-center"><span class="bg-blue-600 text-white px-2 py-1 rounded-md mr-1">D</span><span class="bg-blue-600 text-white px-2 py-1 rounded-md mr-1">A</span><span class="bg-blue-600 text-white px-2 py-1 rounded-md">T</span></div><h2 class="text-2xl font-semibold mt-1">Account</h2></div>
                <div id="profileNavHeader" class="px-6 py-4 border-b border-gray-700"></div>
                 <div id="showMoreAccountsContainer" class="border-b border-gray-700">
                    <button id="showMoreAccountsButton" class="w-full flex items-center justify-between px-6 py-3 text-sm text-gray-300 hover:bg-gray-700">
                        <span>Select Account</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-5 h-5 transition-transform duration-300"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div id="profileAccountListContainer" class="bg-black bg-opacity-20">
                         <div class="p-2 border-b border-gray-700">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                                </span>
                                <input type="text" id="profileAccountSearchInput" placeholder="Search accounts..." class="w-full bg-[#2D3943] text-white rounded py-1 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                        <!-- Current Account in Profile Switcher -->
                        <div id="profileCurrentAccountDisplay" class="p-3 bg-black bg-opacity-25 border-b border-gray-700">
                           <!-- Current user info rendered here -->
                        </div>
                        <div id="profileAccountList" class="py-2 px-2"></div>
                        <div id="profileAccountListNoMatch" class="hidden text-center py-4 text-gray-500 text-sm">No match found</div>
                    </div>
                </div>
                <nav class="flex-1 px-2 py-4"><div class="space-y-1"><a href="#" data-icon-name="user" class="profile-nav-item active flex items-center px-4 py-2 rounded-md"><i data-lucide="user" class="w-5 h-5 mr-3"></i> User Profile</a><a href="#" data-icon-name="search" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="search" class="w-5 h-5 mr-3"></i> Company Profile</a><a href="#" data-icon-name="star" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="star" class="w-5 h-5 mr-3"></i> Manage Reputation</a></div><div class="border-t border-gray-700 my-2"></div><div class="space-y-1"><a href="#" id="toolsLink" data-icon-name="grid" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="grid" class="w-5 h-5 mr-3"></i> Tools</a><a href="#" data-icon-name="message-circle" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Help Center</a><a href="#" data-icon-name="message-square" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Live Support</a></div></nav>
                <div class="px-4 py-2 mt-auto border-t border-gray-700"><a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-1"><i data-lucide="shield" class="w-5 h-5 mr-3"></i> Privacy Policy</a><a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-1"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Terms and Conditions</a><a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-2 mt-2"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Sign Out</a></div>
            </div>

            <!-- Profile Content -->
            <main id="profileContent" class="flex-1 p-8 bg-[#F6F7F9] overflow-y-auto"></main>
        </div>
    </div>

    <!-- Tooltip for Account Information -->
    <div id="accountTooltip" class="hidden absolute z-20 w-80 p-3 bg-[#2D3943] border border-gray-600 rounded-md text-white text-xs shadow-lg space-y-2">
        <!-- Tooltip content will be injected here by JS -->
    </div>


    <script>
        // --- Data ---
        const users = [];
        const baseUsers = [
            { platform: 'iQ', isAdmin: true, initials: 'LS1', fName: 'John', lName: 'Doe', email: 'john.doe1@email.com', phone: '555-555-5551', color: 'bg-gray-500', location: 'Portland, OR', officeCode: 'PDX-01', roles: ['Enterprise Sales Exec', 'Technology Lead'], mcDotNumber: 'MC-100001', subscriptions: ['Directory', 'DAT One'] },
            { platform: 'One', isAdmin: false, initials: 'LS2', fName: 'Jane', lName: 'Smith', email: 'jane.smith@email.com', phone: '555-555-5552', color: 'bg-blue-500', location: 'Denver, CO', officeCode: 'DEN-02', roles: ['Carrier Sales'], mcDotNumber: 'MC-100002', subscriptions: ['DAT One'] },
            { platform: 'One', isAdmin: false, initials: 'LS3', fName: 'Jim', lName: 'Brown', email: 'jim.brown@email.com', phone: '555-555-5553', color: 'bg-green-500', location: 'Atlanta, GA', officeCode: 'ATL-03', roles: ['Logistics Coordinator'], mcDotNumber: 'MC-100003', subscriptions: ['Directory'] },
            { platform: 'iQ + One', isAdmin: false, initials: 'LS4', fName: 'Joan', lName: 'Davis', email: 'joan.davis@email.com', phone: '555-555-5554', color: 'bg-purple-500', location: 'Chicago, IL', officeCode: 'CHI-04', roles: ['Administrator', 'Super User'], mcDotNumber: 'MC-100004', subscriptions: ['Directory', 'DAT One', 'iQ Premium'] }
        ];

        // Generate a large list of accounts to demonstrate scrolling
        for (let i = 1; i <= 25; i++) {
            const base = baseUsers[(i - 1) % baseUsers.length];
            let newSubscriptions = [...base.subscriptions];
            let newRoles = [...base.roles];

            // Add "RateView Multilane" and randomly "TRI Analyst" role if platform includes iQ
            if (base.platform.includes('iQ')) {
                if (!newSubscriptions.includes('RateView Multilane')) {
                    newSubscriptions.push('RateView Multilane');
                }
                // Randomly add "TRI Analyst" role for iQ users
                if (Math.random() > 0.5) {
                    newRoles.push('TRI Analyst');
                }
            }
            
            users.push({
                id: i,
                platform: base.platform,
                name: 'Landstar Ligon', // All accounts are named "Landstar Ligon"
                isAdmin: i === 1 ? true : base.isAdmin, // Make first one admin
                initials: `LS${i}`,
                fName: base.fName,
                lName: base.lName,
                email: `user${i}@landstar.com`,
                phone: `555-555-${5550 + i}`,
                color: base.color,
                company: 'Landstar Ligon', // The company is also Landstar Ligon
                location: `${base.location} #${i}`, // Unique location to differentiate accounts
                officeCode: `${base.officeCode}-${i}`, // Unique office code to differentiate accounts
                roles: newRoles,
                mcDotNumber: `MC-${100000 + i}`,
                subscriptions: newSubscriptions,
                userNotes: '', // Initially empty
                adminNotes: i === 1 ? 'This is the primary admin account for Landstar Ligon.' : '' // Example admin note
            });
        }
        
        let currentUser = users[0];
        // Display location and office code by default
        let globalDisplayPrefs = { location: true, officeCode: true, userNotes: false };
        let currentNavType = 'iQ';
        let tempSelectedPlatform = 'iQ';
        let accountSearchTerm = '';
        let profileAccountSearchTerm = '';

        // --- DOM Elements ---
        const mainNavContainer = document.getElementById('mainNavContainer');
        const accountMenu = document.getElementById('accountMenu');
        const accountList = document.getElementById('accountList');
        const mainAppView = document.getElementById('mainAppView');
        const userProfileView = document.getElementById('userProfileView');
        const accountInfoLink = document.getElementById('accountInfoLink');
        const backToApp = document.getElementById('backToApp');
        const profileNavHeader = document.getElementById('profileNavHeader');
        const profileContent = document.getElementById('profileContent');
        const showMoreAccountsButton = document.getElementById('showMoreAccountsButton');
        const profileAccountListContainer = document.getElementById('profileAccountListContainer');
        const profileAccountList = document.getElementById('profileAccountList');
        const toolsLink = document.getElementById('toolsLink');
        const platformMenu = document.getElementById('platformMenu');
        const platformList = document.getElementById('platformList');
        const platformContinueButton = document.getElementById('platformContinueButton');
        const accountTooltip = document.getElementById('accountTooltip');
        const accountSearchInput = document.getElementById('accountSearchInput');
        const profileAccountSearchInput = document.getElementById('profileAccountSearchInput');
        const accountListNoMatch = document.getElementById('accountListNoMatch');
        const profileAccountListNoMatch = document.getElementById('profileAccountListNoMatch');
        const currentAccountDisplay = document.getElementById('currentAccountDisplay');
        const profileCurrentAccountDisplay = document.getElementById('profileCurrentAccountDisplay');


        // --- Functions ---
        
        function filterUsers(searchTerm) {
            if (!searchTerm) {
                return users; // Return all users if search term is empty
            }
            const lowercasedTerm = searchTerm.toLowerCase();
            return users.filter(user => {
                // Check against all relevant user fields
                return (
                    user.name.toLowerCase().includes(lowercasedTerm) ||
                    user.platform.toLowerCase().includes(lowercasedTerm) ||
                    user.company.toLowerCase().includes(lowercasedTerm) ||
                    user.location.toLowerCase().includes(lowercasedTerm) ||
                    user.officeCode.toLowerCase().includes(lowercasedTerm) ||
                    user.fName.toLowerCase().includes(lowercasedTerm) ||
                    user.lName.toLowerCase().includes(lowercasedTerm) ||
                    user.email.toLowerCase().includes(lowercasedTerm) ||
                    user.phone.toLowerCase().includes(lowercasedTerm) ||
                    user.initials.toLowerCase().includes(lowercasedTerm) ||
                    (user.userNotes && user.userNotes.toLowerCase().includes(lowercasedTerm)) ||
                    user.mcDotNumber.toLowerCase().includes(lowercasedTerm) ||
                    (user.adminNotes && user.adminNotes.toLowerCase().includes(lowercasedTerm)) ||
                    user.roles.join(', ').toLowerCase().includes(lowercasedTerm) ||
                    user.subscriptions.join(', ').toLowerCase().includes(lowercasedTerm)
                );
            });
        }
        
        function getUserDisplay(user, isCurrent = false) {
            const platformLabel = `<span class="text-xs font-normal text-gray-400 ml-2">${user.platform}</span>`;
            const adminLabel = user.isAdmin ? ' <span class="text-xs font-normal text-gray-400 ml-1">- A</span>' : '';
            const infoIcon = `<i data-lucide="info" class="w-4 h-4 text-gray-400 hover:text-white ml-2 cursor-pointer account-info-icon" data-user-id="${user.id}"></i>`;
            
            let details = `<p class="font-semibold text-base flex items-center">${user.name}${!isCurrent ? infoIcon : ''}${platformLabel}${adminLabel}</p>`;
            if (globalDisplayPrefs.userNotes && user.userNotes) details += `<p class="text-xs text-yellow-400 italic">"${user.userNotes}"</p>`;
            if (globalDisplayPrefs.location) details += `<p class="text-xs text-gray-400">${user.location}</p>`;
            if (globalDisplayPrefs.officeCode) details += `<p class="text-xs text-gray-400">${user.officeCode}</p>`;
            
            const checkIcon = isCurrent ? '<div class="absolute right-3 top-1/2 -translate-y-1/2"><i data-lucide="check" class="w-5 h-5 text-green-400"></i></div>' : '';
            const avatar = `<div class="w-8 h-8 mr-3 ${user.color} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0">${user.initials}</div>`;

            return `<div class="flex items-center relative">${avatar}<div>${details}</div>${checkIcon}</div>`;
        }


        function renderNav() {
            let navToRender = currentNavType;
            if (currentUser.platform.includes('iQ') && currentUser.platform.includes('One')) {
                // Keep current nav if user has both
            } else if (currentUser.platform === 'iQ') {
                navToRender = 'iQ';
            } else if (currentUser.platform === 'One') {
                navToRender = 'One';
            }
            
            const isOne = (navToRender === 'One');
            const navItems = isOne ? `
                <div id="logoButton" class="self-stretch px-2 mb-6 flex justify-center cursor-pointer"><div class="w-16 h-12 bg-white rounded flex flex-col items-center justify-center text-gray-800 font-bold text-sm"><div>DAT</div><div class="font-extrabold text-lg">One</div></div></div>
                <div class="self-stretch flex-1 flex flex-col items-start w-full text-sm text-gray-400">
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="home" class="w-5 h-5 mr-3"></i> Dashboard</a>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="search" class="w-5 h-5 mr-3"></i> Search Loads</a>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="truck" class="w-5 h-5 mr-3"></i> Search Trucks</a>
                    <div class="w-full border-t border-gray-700 my-2"></div>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="download" class="w-5 h-5 mr-3"></i> My Shipments</a>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Advanced Posting</a>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="truck" class="w-5 h-5 mr-3"></i> My Trucks</a>
                    <a href="#" class="w-full flex items-center py-2 px-4 hover:bg-gray-700"><i data-lucide="package" class="w-5 h-5 mr-3"></i> My Loads</a>
                </div>
            ` : `
                <div id="logoButton" class="self-stretch px-2 mb-6 flex justify-center cursor-pointer"><div class="w-16 h-12 bg-white rounded flex flex-col items-center justify-center text-gray-800 font-bold text-sm"><div>DAT</div><div class="font-extrabold text-lg">iQ</div></div></div>
                <div class="self-stretch flex-1 flex flex-col items-start gap-2" id="navContainer">
                    <div data-selected="true" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="home" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Dashboard</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="wrench" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">RateView</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="file-text" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Rateview<br>Multi-Lane</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="clipboard-list" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">RFP Tool</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="clock" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Market<br>Conditions</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="bar-chart-3" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Benchmark</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="grid" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">More Tools</div></div>
                </div>
            `;
            
            mainNavContainer.innerHTML = navItems + `<div class="self-stretch mt-auto flex flex-col items-center"><div class="py-4"><div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center cursor-pointer"><i data-lucide="help-circle" class="w-6 h-6 stroke-white"></i></div></div><div class="self-stretch border-t border-Web-Border-Container-Primary flex justify-center py-4"><div id="avatarButton" class="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center text-white text-sm font-medium cursor-pointer">${currentUser.initials}</div></div></div>`;
            mainNavContainer.className = `h-screen pt-6 bg-Web-Fill-Navigation-Default flex flex-col items-center ${isOne ? 'w-64' : 'w-20'}`;
            
            currentNavType = navToRender;

            lucide.createIcons();
        }

        function updatePlatformMenu() {
            const availablePlatforms = [];
            if (currentUser.platform.includes('iQ')) availablePlatforms.push('iQ');
            if (currentUser.platform.includes('One') || currentUser.platform.includes('ONE')) availablePlatforms.push('One');
            
            platformList.innerHTML = availablePlatforms.map(p => `<label class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white cursor-pointer"><input type="radio" name="platform" value="${p}" class="mr-3" ${p === tempSelectedPlatform ? 'checked' : ''}>${p}</label>`).join('');
        }

        function updateUI() {
            renderNav();

            // Update Current Account Displays
            currentAccountDisplay.innerHTML = getUserDisplay(currentUser, true);
            profileCurrentAccountDisplay.innerHTML = getUserDisplay(currentUser, true);
            
            // Filter and update account list in main pop-out
            const mainFilteredUsers = filterUsers(accountSearchTerm).filter(u => u.id !== currentUser.id);
            if(mainFilteredUsers.length === 0 && accountSearchTerm) {
                accountList.innerHTML = '';
                accountListNoMatch.classList.remove('hidden');
            } else {
                accountListNoMatch.classList.add('hidden');
                accountList.innerHTML = mainFilteredUsers.map(u => `<div data-user-id="${u.id}" class="account-item flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white cursor-pointer">${getUserDisplay(u)}</div>`).join('');
            }
            
            // Update profile page nav header
            profileNavHeader.innerHTML = `<div class="flex items-center"><div class="w-12 h-12 ${currentUser.color} rounded-full flex items-center justify-center text-white text-lg font-medium mr-3 flex-shrink-0">${currentUser.initials}</div><div>${getUserDisplay(currentUser, true)}</div></div>`;

            // Filter and update profile page account list
            const profileFilteredUsers = filterUsers(profileAccountSearchTerm).filter(u => u.id !== currentUser.id);
            if(profileFilteredUsers.length === 0 && profileAccountSearchTerm) {
                 profileAccountList.innerHTML = '';
                 profileAccountListNoMatch.classList.remove('hidden');
            } else {
                profileAccountListNoMatch.classList.add('hidden');
                profileAccountList.innerHTML = profileFilteredUsers.map(u => `<div data-user-id="${u.id}" class="account-item flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white cursor-pointer">${getUserDisplay(u)}</div>`).join('');
            }
            
            lucide.createIcons();
        }


        function renderUserProfile() {
            profileContent.innerHTML = `
                <div class="space-y-8">
                    <!-- User Details Card -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">User Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                            <div>
                                <label class="text-xs text-gray-500">Username</label>
                                <p class="text-gray-800 font-medium">${currentUser.name}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Full Name</label>
                                <p class="text-gray-800 font-medium">${currentUser.fName} ${currentUser.lName}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Login Email</label>
                                <p class="text-gray-800 font-medium">${currentUser.email}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Contact Phone</label>
                                <p class="text-gray-800 font-medium">${currentUser.phone}</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Salesforce & CSB Roles</label>
                                <p class="text-gray-800 font-medium">${currentUser.roles.join(', ')}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Account Details Card -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Account Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 text-sm">
                            <div>
                                <label class="text-xs text-gray-500">Account Name</label>
                                <p class="text-gray-800 font-medium">${currentUser.company}</p>
                            </div>
                             <div>
                                <label class="text-xs text-gray-500">Site Location</label>
                                <p class="text-gray-800 font-medium">${currentUser.location}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Office Code</label>
                                <p class="text-gray-800 font-medium">${currentUser.officeCode}</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">MC/DOT Number</label>
                                <p class="text-gray-800 font-medium">${currentUser.mcDotNumber}</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Subscriptions</label>
                                <p class="text-gray-800 font-medium">${[...new Set(currentUser.subscriptions)].join(', ')}</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs text-gray-500">Admin Notes</label>
                                <textarea id="adminNotesInput" rows="3" class="w-full mt-1 text-sm rounded bg-gray-50 p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-200 disabled:text-gray-500 disabled:cursor-not-allowed" ${currentUser.isAdmin ? '' : 'disabled'}>${currentUser.adminNotes || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Account Switcher Display Card -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Account Switcher Display</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" data-pref="location" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${globalDisplayPrefs.location ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-700">Site Location</span>
                            </label>
                             <label class="flex items-center">
                                <input type="checkbox" data-pref="officeCode" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${globalDisplayPrefs.officeCode ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-700">Office Code</span>
                            </label>
                            <div class="flex items-center pt-1">
                                <input type="checkbox" data-pref="userNotes" id="userNotesCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${globalDisplayPrefs.userNotes ? 'checked' : ''}>
                                <label for="userNotesCheckbox" class="ml-3 text-sm text-gray-700 mr-4">User Notes</label>
                                <input type="text" id="userNotesInput" value="${currentUser.userNotes || ''}" placeholder="Enter user notes" class="text-sm w-full max-w-xs rounded bg-gray-50 p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-200 disabled:cursor-not-allowed" ${!globalDisplayPrefs.userNotes ? 'disabled' : ''}>
                            </div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => { updateUI(); lucide.createIcons(); });
        
        mainNavContainer.addEventListener('click', (e) => {
            const avatarButton = e.target.closest('#avatarButton');
            const logoButton = e.target.closest('#logoButton');
            const navItem = e.target.closest('.nav-item');

            if (avatarButton) {
                e.stopPropagation();
                accountSearchInput.value = ''; // Clear search on open
                accountSearchTerm = '';
                updateUI();
                accountMenu.classList.toggle('hidden');
            } else if (logoButton) {
                e.stopPropagation();
                tempSelectedPlatform = currentNavType;
                updatePlatformMenu();
                platformMenu.classList.toggle('hidden');
            } else if (navItem && navItem.parentElement.id === 'navContainer') {
                // Handle nav item selection for iQ style nav
                const currentSelected = mainNavContainer.querySelector('.nav-item[data-selected="true"]');
                if (currentSelected) {
                    currentSelected.dataset.selected = 'false';
                }
                navItem.dataset.selected = 'true';
            }
        });

        if (platformContinueButton) { platformContinueButton.addEventListener('click', (e) => { e.stopPropagation(); currentNavType = tempSelectedPlatform; renderNav(); platformMenu.classList.add('hidden'); }); }
        if (accountInfoLink) { accountInfoLink.addEventListener('click', (e) => { e.preventDefault(); renderUserProfile(); mainAppView.classList.add('hidden'); userProfileView.classList.remove('hidden'); accountMenu.classList.add('hidden'); }); }
        if (backToApp) { backToApp.addEventListener('click', () => { userProfileView.classList.add('hidden'); mainAppView.classList.remove('hidden'); }); }
        if (toolsLink) { toolsLink.addEventListener('click', (e) => { e.preventDefault(); userProfileView.classList.add('hidden'); mainAppView.classList.remove('hidden'); }); }
        if (showMoreAccountsButton) { showMoreAccountsButton.addEventListener('click', (e) => { e.stopPropagation(); profileAccountSearchInput.value = ''; profileAccountSearchTerm = ''; updateUI(); const icon = showMoreAccountsButton.querySelector('svg'); if (profileAccountListContainer.style.maxHeight) { profileAccountListContainer.style.maxHeight = null; icon.classList.remove('rotate-180'); } else { profileAccountListContainer.style.maxHeight = profileAccountListContainer.scrollHeight + "px"; icon.classList.add('rotate-180'); } }); }
        
        if (platformList) { platformList.addEventListener('change', (e) => { if(e.target.name === 'platform') { tempSelectedPlatform = e.target.value; } }); }
        
        // Account switching logic
        accountList.addEventListener('click', (e) => {
            const accountItem = e.target.closest('.account-item');
            if(accountItem) {
                const userId = parseInt(accountItem.dataset.userId);
                currentUser = users.find(u => u.id === userId) || currentUser;
                updateUI();
                accountMenu.classList.add('hidden');
            }
        });

        profileAccountList.addEventListener('click', (e) => {
            const accountItem = e.target.closest('.account-item');
            if(accountItem) {
                const userId = parseInt(accountItem.dataset.userId);
                currentUser = users.find(u => u.id === userId) || currentUser;
                renderUserProfile(); // Rerender profile page with new user data
                updateUI();
                 // Close the dropdown
                profileAccountListContainer.style.maxHeight = null;
                const icon = showMoreAccountsButton.querySelector('svg');
                if(icon) { icon.classList.remove('rotate-180'); }
            }
        });
        
        profileContent.addEventListener('input', (e) => {
            const userToUpdate = users.find(u => u.id === currentUser.id);
            if (!userToUpdate) return;
            
            if (e.target.id === 'userNotesInput') {
                userToUpdate.userNotes = e.target.value;
                currentUser.userNotes = e.target.value;
                updateUI(); // Update switchers in real-time
            }

            if (e.target.id === 'adminNotesInput' && currentUser.isAdmin) {
                userToUpdate.adminNotes = e.target.value;
                currentUser.adminNotes = e.target.value;
                // No UI update needed as it doesn't affect the switcher
            }
        });

        profileContent.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox' && e.target.dataset.pref) {
                const pref = e.target.dataset.pref;
                globalDisplayPrefs[pref] = e.target.checked;
                // When userNotes checkbox changes, re-render user profile to enable/disable input
                renderUserProfile();
                updateUI(); // This will update the switchers
            }
        });

        // Search input listeners
        if(accountSearchInput) { accountSearchInput.addEventListener('input', (e) => { accountSearchTerm = e.target.value; updateUI(); }); }
        if(profileAccountSearchInput) { profileAccountSearchInput.addEventListener('input', (e) => { profileAccountSearchTerm = e.target.value; updateUI(); }); }


        userProfileView.addEventListener('click', (e) => {
            const profileNavItem = e.target.closest('.profile-nav-item');
            if (profileNavItem) {
                e.preventDefault();
                const navContainer = profileNavItem.closest('nav');
                if (navContainer) {
                    const currentActive = navContainer.querySelector('.active');
                    if (currentActive) currentActive.classList.remove('active');
                    profileNavItem.classList.add('active');

                    // Change content based on selection
                    const linkText = profileNavItem.innerText.trim();
                    const iconName = profileNavItem.dataset.iconName;

                    if (linkText !== 'User Profile') {
                        if (!iconName) { // Guard against missing icon name
                            console.error("Could not find icon name for nav item:", profileNavItem);
                            return;
                        }
                        profileContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md h-full flex flex-col items-center justify-center text-center">
                            <i data-lucide="${iconName}" class="w-16 h-16 text-gray-300 mb-4"></i>
                            <h1 class="text-2xl font-bold text-gray-800">${linkText}</h1>
                            <p class="mt-2 text-gray-600 max-w-md">This is a placeholder page for the "${linkText}" section. All of the relevant tools and content would be displayed here.</p>
                        </div>`;
                        lucide.createIcons();
                    } else {
                        renderUserProfile(); // Re-render the main profile content
                    }
                }
            }
        });

        // --- Tooltip Logic ---
        function showTooltip(e) {
            const target = e.target.closest('.account-info-icon');
            if (!target) return;

            const userId = parseInt(target.dataset.userId);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const userNotesHTML = user.userNotes ? `<div class="mt-2 pt-2 border-t border-gray-600">
                <h5 class="font-bold text-gray-300">User Notes</h5>
                <p class="italic text-yellow-300">"${user.userNotes}"</p>
            </div>` : '';

            const adminNotesHTML = user.adminNotes ? `<div class="mt-2 pt-2 border-t border-gray-600">
                <h5 class="font-bold text-gray-300">Admin Notes</h5>
                <p>${user.adminNotes}</p>
            </div>` : '';

            // Populate tooltip
            accountTooltip.innerHTML = `
                <div class="space-y-1">
                    <h4 class="font-bold text-base mb-2 border-b border-gray-600 pb-1">${user.company}</h4>
                    
                    <h5 class="font-bold text-gray-300">User Details</h5>
                    <p><span class="font-semibold text-gray-400">Full Name:</span> ${user.fName} ${user.lName}</p>
                    <p><span class="font-semibold text-gray-400">Username:</span> ${user.name}</p>
                    <p><span class="font-semibold text-gray-400">Email:</span> ${user.email}</p>
                    <p><span class="font-semibold text-gray-400">Phone:</span> ${user.phone}</p>
                    <p><span class="font-semibold text-gray-400">Roles:</span> ${user.roles.join(', ')}</p>

                    <div class="mt-2 pt-2 border-t border-gray-600">
                        <h5 class="font-bold text-gray-300">Account Details</h5>
                        <p><span class="font-semibold text-gray-400">Location:</span> ${user.location}</p>
                        <p><span class="font-semibold text-gray-400">Office:</span> ${user.officeCode}</p>
                        <p><span class="font-semibold text-gray-400">MC/DOT:</span> ${user.mcDotNumber}</p>
                        <p><span class="font-semibold text-gray-400">Subscriptions:</span> ${[...new Set(user.subscriptions)].join(', ')}</p>
                    </div>

                    ${userNotesHTML}
                    ${adminNotesHTML}
                </div>
            `;

            // Position tooltip
            const rect = target.getBoundingClientRect();
            accountTooltip.style.left = `${rect.right + 10}px`;
            
            // Adjust vertical position to prevent overflow
            const tooltipHeight = accountTooltip.offsetHeight;
            const windowHeight = window.innerHeight;
            let topPosition = rect.top;

            if (topPosition + tooltipHeight > windowHeight - 20) { // 20px buffer
                topPosition = windowHeight - tooltipHeight - 20;
            }
            if (topPosition < 20) {
                topPosition = 20;
            }

            accountTooltip.style.top = `${topPosition}px`;
            accountTooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            accountTooltip.classList.add('hidden');
        }
        
        accountList.addEventListener('mouseover', showTooltip);
        accountList.addEventListener('mouseout', hideTooltip);

        profileAccountList.addEventListener('mouseover', showTooltip);
        profileAccountList.addEventListener('mouseout', hideTooltip);


        window.addEventListener('click', (e) => {
            if (accountMenu && !accountMenu.contains(e.target) && !e.target.closest('#avatarButton')) { accountMenu.classList.add('hidden'); }
            if (platformMenu && !platformMenu.contains(e.target) && !e.target.closest('#logoButton')) { platformMenu.classList.add('hidden'); }
        });

    </script>
</body>
</html>

