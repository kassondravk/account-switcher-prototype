<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iQ Navigation Panel</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector-based icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inter font for the entire application -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styling for the page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F6F7F9;
            margin: 0;
            display: flex;
            justify-content: flex-start; /* Align content to the left */
            align-items: flex-start;
            min-height: 100vh;
        }

        /* --- Design System Color Placeholders (For clarity) --- */
        .bg-Web-Fill-Navigation-Default { background-color: #192129; }
        .text-Web-Text-Navigation-Default { color: #9ca3af; } /* Example: Gray-400 */
        .text-Web-Text-Navigation-Selected { color: #ffffff; } /* Example: White */
        .bg-Web-Fill-Navigation-Selected { background-color: #2D3943; }
        .border-Web-Border-Container-Primary { border-color: #4b5563; } /* Example: Gray-600 */
        .bg-Web-Text-Static-Inverse { background-color: #f9fafb; } /* Example: Gray-50 (for logo placeholder) */

        /* --- Minimal CSS for state transitions and overrides --- */
        .nav-item {
            transition: background-color 0.2s ease;
            min-height: 60px; /* Ensure items have enough height for two lines */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Hover state for navigation items */
        .nav-item:not([data-selected="true"]):hover {
            background-color: #252f3a; /* Hover background */
        }
        .nav-item:not([data-selected="true"]):hover .text-Web-Text-Navigation-Default {
            color: #d1d5db; /* Lighter gray text on hover */
        }
        .nav-item:not([data-selected="true"]):hover .icon-default {
            stroke: #d1d5db; /* Lighter gray icon on hover */
        }

        /* Selected state styling */
        .nav-item[data-selected="true"] {
            background-color: var(--bg-Web-Fill-Navigation-Selected, #2D3943); /* Selected background */
        }
        .nav-item[data-selected="true"] .text-Web-Text-Navigation-Default {
            color: var(--text-Web-Text-Navigation-Selected, #ffffff); /* Selected text color */
            font-weight: 600; /* Bolder text for selected item */
        }
        .nav-item[data-selected="true"] .icon-default {
            stroke: var(--text-Web-Text-Navigation-Selected, #ffffff); /* Selected icon color */
        }

        /* Default icon color */
        .nav-item .icon-default {
            stroke: var(--text-Web-Text-Navigation-Default, #9ca3af);
        }

        /* Account menu styling */
        .account-menu {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* User Profile Page specific styles */
        .profile-nav-item {
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 4px; /* Added rounded corners */
        }
        .profile-nav-item.active {
            background-color: #2D3943;
            color: #ffffff;
            font-weight: 600; /* Bolder text for selected item */
        }
        .profile-nav-item:not(.active):hover {
             background-color: #252f3a; /* Darker hover */
            color: #d1d5db; /* Lighter text on hover */
        }
        
        /* Styles for the scrollable account switcher */
        #accountList, #profileAccountList {
            max-height: 300px; /* Set a max height to enable scrolling */
            overflow-y: auto; /* Show scrollbar when content overflows */
        }

        /* Custom scrollbar for account switcher to match the dark theme */
        #accountList::-webkit-scrollbar, #profileAccountList::-webkit-scrollbar {
            width: 8px;
        }
        #accountList::-webkit-scrollbar-track, #profileAccountList::-webkit-scrollbar-track {
            background: #2D3943;
        }
        #accountList::-webkit-scrollbar-thumb, #profileAccountList::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
            border: 2px solid #2D3943;
        }
        #accountList::-webkit-scrollbar-thumb:hover, #profileAccountList::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
        
        /* Profile Page Card Styles */
        .profile-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 8px; /* rounded-lg */
        }
        .profile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px; /* p-4 md:p-6 */
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .profile-card-header:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .profile-card-header h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-800 */
        }
        .profile-card-header .lucide {
            transition: transform 0.3s ease;
        }
        /* Clicks on collapse icon are handled separately */
        .collapse-icon {
            cursor: pointer;
        }
        /* Clicks on header (not icon) should not be pointer */
        .profile-card-header[data-card-id="accountSwitcherCard"],
        .profile-card-header[data-card-id="mobileNotificationsCard"] {
            cursor: default;
        }
        
        .profile-card-content {
            padding: 24px; /* p-6 */
            transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out, padding 0.3s ease-out;
            max-height: 2000px; /* Arbitrary large value for expansion */
            opacity: 1;
            overflow: hidden;
        }
        .profile-card-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none;
        }
        
        .profile-card-summary {
             padding: 24px; /* p-6 */
             border-top: 1px solid #e5e7eb;
        }
        
        /* When content is collapsed, the header's bottom border is removed */
         .profile-card-content.collapsed + .profile-card-summary {
            border-top: none;
        }
        
        .profile-card-header.no-border {
             border-bottom: none;
        }
        
        
        /* M3-style text field from design system doc */
        .m3-text-field {
           position: relative; 
           border: 1px solid #79747E; /* Neutral outline color */
           border-radius: 4px; 
           background-color: #ffffff; /* White background */
           transition: border-color 0.2s ease, background-color 0.2s ease;
           width: 100%;
        }
        /* --- M3 Style for regular input --- */
        .m3-text-field input {
            border: none; 
            outline: none; 
            background-color: transparent;
            width: 100%; 
            font-size: 16px; 
            color: #1D1B20; 
            padding: 16px 16px 8px 16px; 
            box-sizing: border-box; 
            height: 52px; /* Fixed height for input */
        }
        
         .m3-text-field textarea {
            border: none; 
            outline: none; 
            background-color: transparent;
            width: 100%; 
            font-size: 16px; 
            color: #1D1B20; 
            padding: 16px 16px 8px 16px; /* Padding for text area */
            box-sizing: border-box; 
            resize: vertical;
            min-height: 80px;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        
         .m3-text-field label {
            position: absolute; 
            left: 16px; 
            top: 16px; /* Align with input's top padding */
            font-size: 16px; 
            color: #49454F; 
            pointer-events: none; 
            transition: top 0.2s ease, font-size 0.2s ease, color 0.2s ease, background-color 0.2s ease, padding 0.2s ease, left 0.2s ease; 
            transform-origin: left top; 
            background-color: #ffffff; /* Match container bg */
            padding: 0 4px; /* Add horizontal padding */
        }
        /* --- Adjust label for standard input --- */
        .m3-text-field input + label {
            top: 15px; /* Slightly adjust for input height */
        }

        /* Label float styles */
        .m3-text-field.focused label,
        .m3-text-field.filled label {
            top: -10px; /* Move label above the input area */
            font-size: 12px; 
            left: 12px; 
            color: #0046E0; /* Active blue */
        }
        
         .m3-text-field.focused {
             border-color: #0046E0; /* Active blue border */
             border-width: 2px;
         }
         /* Adjust padding/margin when focused to prevent layout shift */
         .m3-text-field.focused textarea {
             padding: 15px 15px 7px 15px; /* Adjust by 1px to account for 2px border */
         }
         .m3-text-field.focused input {
             padding: 15px 15px 7px 15px;
         }
         .m3-text-field.focused label {
             top: -11px; /* Adjust by 1px for 2px border */
         }
         /* --- Adjust label for input focus --- */
         .m3-text-field.focused input + label {
             top: -11px;
         }


         .m3-text-field.disabled {
            border-color: rgba(29, 27, 32, 0.12);
            background-color: #f9fafb; /* bg-gray-50 */
         }
         .m3-text-field.disabled textarea,
         .m3-text-field.disabled input {
             color: rgba(29, 27, 32, 0.38);
             cursor: not-allowed;
             background-color: #f9fafb; /* bg-gray-50 */
         }
         .m3-text-field.disabled label {
            color: rgba(29, 27, 32, 0.38);
            background-color: #f9fafb; /* bg-gray-50 */
         }
         /* Keep label floated if disabled but filled */
         .m3-text-field.disabled.filled label {
             top: -10px;
             font-size: 12px;
             left: 12px;
         }


    </style>
</head>
<body class="bg-white">

    <!-- Main App View -->
    <div id="mainAppView" class="flex">
        <div class="relative flex">
            <!-- Main navigation container -->
            <div id="mainNavContainer" class="w-20 h-screen pt-6 bg-Web-Fill-Navigation-Default flex flex-col items-center">
                <!-- Nav content is rendered here by JS -->
            </div>

            <!-- Account Menu (Initially Hidden) -->
            <div id="accountMenu" class="hidden absolute left-full ml-2 bottom-4 w-72 bg-[#192129] text-white rounded-md account-menu z-10 flex flex-col">
                <div class="px-4 py-3 border-b border-gray-700">
                    <h3 class="text-lg font-semibold text-center">Select Account</h3>
                    <div class="relative mt-2">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                        </span>
                        <input type="text" id="accountSearchInput" placeholder="Search accounts..." class="w-full bg-[#2D3943] text-white rounded py-1 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Currently Selected Account -->
                <div id="currentAccountDisplay" class="p-3 bg-black bg-opacity-20 border-b border-gray-700">
                    <!-- Current user info rendered here -->
                </div>
                <div class="flex-1 min-h-0">
                    <div id="accountList" class="py-2"></div>
                    <div id="accountListNoMatch" class="hidden text-center py-4 text-gray-500 text-sm">No match found</div>
                </div>
                <div class="border-t border-gray-700 py-2"><a href="#" id="accountInfoLink" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Account Information</a><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Live Support</a><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Help Center</a></div>
                <div class="border-t border-gray-700 py-2"><a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Log Out</a></div>
            </div>
        </div>
    </div>

    <!-- User Profile View (Initially Hidden) -->
    <div id="userProfileView" class="hidden w-full h-screen">
        <!-- Added relative positioning -->
        <div class="flex h-full relative">
            <!-- Profile Navigation -->
            <div class="w-64 h-full bg-Web-Fill-Navigation-Default text-white flex flex-col">
                <!-- Logo/Back Button -->
                <div id="backToApp" class="px-6 py-4 border-b border-gray-700 cursor-pointer flex items-center space-x-2">
                    <div class="text-2xl font-bold flex items-center">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded-md mr-1">D</span>
                        <span class="bg-blue-600 text-white px-2 py-1 rounded-md mr-1">A</span>
                        <span class="bg-blue-600 text-white px-2 py-1 rounded-md">T</span>
                    </div>
                    <h2 class="text-2xl font-semibold mt-1">Account</h2>
                </div>
                
                <!-- Profile Nav Header (Current User) -->
                <div id="profileNavHeader" class="px-6 py-4 border-b border-gray-700">
                    <!-- Current user info rendered here -->
                </div>
                
                <!-- Account Switcher Dropdown Trigger -->
                 <div id="showMoreAccountsContainer" class="border-b border-gray-700">
                    <!-- This button now toggles the pop-out -->
                    <button id="showMoreAccountsButton" class="w-full flex items-center justify-between px-6 py-3 text-sm text-gray-300 hover:bg-gray-700">
                        <span>Select Account</span>
                        <!-- Icon changed to chevron-right -->
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                    <!-- The inline container has been removed -->
                </div>
                
                <!-- Main Profile Navigation Links -->
                <nav id="profileNavLinks" class="flex-1 px-4 py-4 space-y-1">
                    <a href="#" data-icon-name="user" class="profile-nav-item active flex items-center px-4 py-2 rounded-md"><i data-lucide="user" class="w-5 h-5 mr-3"></i> User Profile</a>
                    <a href="#" data-icon-name="briefcase" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Company Profile</a>
                    <a href="#" data-icon-name="star" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="star" class="w-5 h-5 mr-3"></i> Manage Reputation</a>
                    
                    <div class="border-t border-gray-700 my-2"></div>
                    
                    <a href="#" id="toolsLink" data-icon-name="grid" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="grid" class="w-5 h-5 mr-3"></i> Tools</a>
                    <a href="#" data-icon-name="help-circle" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="help-circle" class="w-5 h-5 mr-3"></i> Help Center</a>
                    <a href="#" data-icon-name="message-square" class="profile-nav-item flex items-center px-4 py-2 rounded-md"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Live Support</a>
                </nav>
                
                <!-- Footer Links -->
                <div class="px-6 py-4 mt-auto border-t border-gray-700 space-y-2">
                    <a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-1"><i data-lucide="shield" class="w-5 h-5 mr-3"></i> Privacy Policy</a>
                    <a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-1"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Terms and Conditions</a>
                    <a href="#" class="flex items-center text-sm text-gray-400 hover:text-white py-2 mt-2"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Sign Out</a>
                </div>
            </div>

            <!-- NEW Profile Account Menu (Pop-out) -->
            <div id="profileAccountMenu" class="hidden absolute left-64 ml-2 w-72 bg-[#192129] text-white rounded-md account-menu z-10 flex flex-col">
                <div class="px-4 py-3 border-b border-gray-700">
                    <h3 class="text-lg font-semibold text-center">Select Account</h3>
                    <div class="relative mt-2">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                        </span>
                        <input type="text" id="profileAccountSearchInput" placeholder="Search accounts..." class="w-full bg-[#2D3943] text-white rounded py-1 pl-9 pr-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Current Account in Profile Switcher -->
                <div id="profileCurrentAccountDisplay" class="p-3 bg-black bg-opacity-25 border-b border-gray-700">
                   <!-- Current user info rendered here -->
                </div>
                <div class="flex-1 min-h-0">
                    <div id="profileAccountList" class="py-2 px-2"></div>
                    <div id="profileAccountListNoMatch" class="hidden text-center py-4 text-gray-500 text-sm">No match found</div>
                </div>
                 <!-- Added footer link to go back to account info -->
                <div class="border-t border-gray-700 py-2">
                    <a href="#" id="profileAccountInfoLink" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-lucide="user" class="w-5 h-5 mr-3"></i> Account Information
                    </a>
                </div>
            </div>

            <!-- Profile Content -->
            <main id="profileContent" class="flex-1 p-8 bg-[#F6F7F9] overflow-y-auto">
                 <div class="max-w-4xl mx-auto">
                    <h1 class="text-2xl font-bold text-gray-900 mb-1">User Profile</h1>
                    <p class="text-sm text-gray-500 mb-6" id="lastUpdatedText">Last Updated: Oct 18, 2025, by DAT</p>
                    
                    <div id="profileCardContainer" class="space-y-6">
                        <!-- Profile cards will be rendered here by JS -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Tooltip for Account Information -->
    <div id="accountTooltip" class="hidden absolute z-20 w-80 p-3 bg-[#2D3943] border border-gray-600 rounded-md text-white text-xs shadow-lg space-y-2">
        <!-- Tooltip content will be injected here by JS -->
    </div>


    <script>
        // --- Data ---
        const users = [];
        // Admin Authority Levels
        const adminLevels = ['Change', 'Corporate Change', 'Full', 'Corporate Full', 'Billing', 'Corporate Billing', 'no admin permission'];
        
        // --- NEW: Subscription choices ---
        const subscriptionChoices = ['iQ', 'One', 'iQ + One'];
        
        // --- NEW: Base data for randomization ---
        const platforms = ['iQ', 'One', 'iQ + One'];
        const colors = ['bg-gray-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500'];
        const locations = [
            { location: 'Portland, OR', officeCode: 'PDX-01' },
            { location: 'Denver, CO', officeCode: 'DEN-02' },
            { location: 'Atlanta, GA', officeCode: 'ATL-03' },
            { location: 'Chicago, IL', officeCode: 'CHI-04' }
        ];

        // Generate a large list of accounts to demonstrate scrolling
        for (let i = 1; i <= 25; i++) {
            const randomBase = locations[i % locations.length];
            const randomPlatform = platforms[i % platforms.length];
            
            // --- Assign random subscription ---
            let subscription = subscriptionChoices[Math.floor(Math.random() * subscriptionChoices.length)];
            
            // --- NEW: Assign Capabilities ---
            let capabilities = [];
            if (subscription.includes('iQ')) {
                if (Math.random() > 0.5) capabilities.push('Multilane Download');
                if (Math.random() > 0.5) capabilities.push('TRI-Analyst');
            }
            
            // --- Admin Authority Level ---
            let authorityLevel = 'Corporate Change'; // --- CONSTANT ---

            // --- VARYING DATA ---
            let contactPhone = '+1 (503) 585-0528';
            let altPhone = '+1 (503) 585-0528';
            let contactEmail = 'chris.anderson@apexlinkglobal.com';

            if (i % 5 === 0) { // Vary 1 in 5
                contactPhone = `+1 (555) 123-45${i < 10 ? '0' : ''}${i}`;
                contactEmail = `contact.alt${i}@apexlinkglobal.com`;
            }
            if (i % 3 === 0) { // Vary 1 in 3
                altPhone = `+1 (555) 987-65${i < 10 ? '0' : ''}${i}`;
            }

            users.push({
                id: i,
                platform: randomPlatform,
                name: 'ApexLink Global', 
                isAdmin: i === 1 ? true : (Math.random() > 0.8), // Make first one admin, and a few others
                initials: `AG`, 
                fName: 'Christopher', // --- CONSTANT ---
                lName: 'Anderson', // --- CONSTANT ---
                email: 'chris.anderson@apexlinkglobal.com', // --- CONSTANT (Login Email) ---
                phone: contactPhone, // --- VARIED ---
                altPhone: altPhone, // --- VARIED ---
                contactEmail: contactEmail, // --- VARIED ---
                color: colors[i % colors.length],
                company: 'ApexLink Global', 
                location: `${randomBase.location} #${i}`, 
                officeCode: `${randomBase.officeCode}-${i}`, 
                adminAuthorityLevel: authorityLevel, 
                mcDotNumber: `MC-${100000 + i}`,
                subscriptions: subscription, 
                capabilities: capabilities, 
                userNotes: '', 
                adminNotes: i === 1 ? '' : '', // All notes empty for usability test
                mobileNumber: '+1 555-555-5552', // Constant for now
                isParent: i === 1 ? true : false, // --- Set first user as parent ---
            });
        }
        
        // --- Set current user ---
        let currentUser = users[0];
        
        // --- CHANGE FOR USABILITY TEST ---
        // All display preferences are off by default.
        let globalDisplayPrefs = { location: false, officeCode: false, userNotes: false, adminNotes: false };
        // --- END CHANGE ---

        let currentNavType = 'iQ';
        let accountSearchTerm = '';
        let profileAccountSearchTerm = '';
        
        // State for collapsible cards
        let cardStates = {
            userDetails: false, // Default to expanded per screenshot
            accountSwitcher: false, // Default to expanded
            accountSwitcherEditMode: false, 
            mobileNotifications: false, // Default to expanded
            mobileNotificationsEditMode: false, // --- NEW ---
            authorityLevel: false // Default to expanded
        };

        // --- DOM Elements ---
        // DOM element getters moved inside functions that use them 
        // to avoid null references on page load
        
        function getNavElements() {
             return {
                mainNavContainer: document.getElementById('mainNavContainer'),
                avatarButton: document.getElementById('avatarButton')
             };
        }

        function getAppElements() {
            return {
                accountMenu: document.getElementById('accountMenu'),
                accountList: document.getElementById('accountList'),
                accountSearchInput: document.getElementById('accountSearchInput'),
                accountListNoMatch: document.getElementById('accountListNoMatch'),
                currentAccountDisplay: document.getElementById('currentAccountDisplay'),
                accountInfoLink: document.getElementById('accountInfoLink'),
                mainAppView: document.getElementById('mainAppView'),
                userProfileView: document.getElementById('userProfileView')
            };
        }

        function getProfileElements() {
            return {
                profileAccountInfoLink: document.getElementById('profileAccountInfoLink'),
                backToApp: document.getElementById('backToApp'),
                profileNavHeader: document.getElementById('profileNavHeader'),
                profileContent: document.getElementById('profileContent'),
                profileCardContainer: document.getElementById('profileCardContainer'),
                showMoreAccountsButton: document.getElementById('showMoreAccountsButton'),
                profileAccountMenu: document.getElementById('profileAccountMenu'),
                profileAccountList: document.getElementById('profileAccountList'),
                profileAccountSearchInput: document.getElementById('profileAccountSearchInput'),
                profileAccountListNoMatch: document.getElementById('profileAccountListNoMatch'),
                profileCurrentAccountDisplay: document.getElementById('profileCurrentAccountDisplay'),
                toolsLink: document.getElementById('toolsLink'),
                profileNavLinks: document.getElementById('profileNavLinks') // --- NEW ---
            };
        }

        const accountTooltip = document.getElementById('accountTooltip');


        // --- Functions ---
        
        function filterUsers(searchTerm) {
            if (!searchTerm) {
                return users; // Return all users if search term is empty
            }
            const lowercasedTerm = searchTerm.toLowerCase();
            return users.filter(user => {
                // Check against all relevant user fields
                return (
                    user.name.toLowerCase().includes(lowercasedTerm) ||
                    user.platform.toLowerCase().includes(lowercasedTerm) ||
                    user.company.toLowerCase().includes(lowercasedTerm) ||
                    user.location.toLowerCase().includes(lowercasedTerm) ||
                    user.officeCode.toLowerCase().includes(lowercasedTerm) ||
                    user.fName.toLowerCase().includes(lowercasedTerm) ||
                    user.lName.toLowerCase().includes(lowercasedTerm) ||
                    user.email.toLowerCase().includes(lowercasedTerm) ||
                    user.phone.toLowerCase().includes(lowercasedTerm) ||
                    user.altPhone.toLowerCase().includes(lowercasedTerm) || // --- ADDED ---
                    user.contactEmail.toLowerCase().includes(lowercasedTerm) || // --- ADDED ---
                    user.initials.toLowerCase().includes(lowercasedTerm) ||
                    (user.userNotes && user.userNotes.toLowerCase().includes(lowercasedTerm)) ||
                    user.mcDotNumber.toLowerCase().includes(lowercasedTerm) ||
                    (user.adminNotes && user.adminNotes.toLowerCase().includes(lowercasedTerm)) ||
                    (user.adminAuthorityLevel && user.adminAuthorityLevel.toLowerCase().includes(lowercasedTerm)) ||
                    (user.subscriptions && user.subscriptions.toLowerCase().includes(lowercasedTerm)) || // --- UPDATED ---
                    (user.capabilities && user.capabilities.join(', ').toLowerCase().includes(lowercasedTerm)) // --- NEW ---
                );
            });
        }
        
        // Moved buildSummaryList to global scope
        function buildSummaryList() {
            let items = [];
            if (globalDisplayPrefs.location) {
                items.push(`<div class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0"></i><span class="text-sm font-medium text-gray-800">Account Site</span></div>`);
            }
            if (globalDisplayPrefs.officeCode) {
                items.push(`<div class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0"></i><span class="text-sm font-medium text-gray-800">Office Code</span></div>`);
            }
            
            // Updated logic for Admin Notes
            if (globalDisplayPrefs.adminNotes) {
                let noteText = currentUser.adminNotes ? `<span class="text-sm text-gray-600 italic ml-1">"${currentUser.adminNotes}"</span>` : '';
                items.push(`<div class="flex items-start"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5"></i><div><span class="text-sm font-medium text-gray-800">Admin Notes</span>${noteText}</div></div>`);
            }

                // Updated logic for User Notes
                if (globalDisplayPrefs.userNotes) {
                let noteText = currentUser.userNotes ? `<span class="text-sm text-gray-600 italic ml-1">"${currentUser.userNotes}"</span>` : '';
                items.push(`<div class="flex items-start"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5"></i><div><span class="text-sm font-medium text-gray-800">User Notes</span>${noteText}</div></div>`);
            }

            if (items.length === 0) {
                return '<p class="text-sm text-gray-500">No display preferences selected.</p>';
            }
            return `<div class="space-y-3">${items.join('')}</div>`;
        };
        
        function getUserDisplay(user, isCurrent = false) {
            const infoIcon = `<i data-lucide="info" class="w-4 h-4 text-gray-400 hover:text-white ml-2 cursor-pointer account-info-icon" data-user-id="${user.id}"></i>`;
            const parentIcon = user.isParent ? `<i data-lucide="network" class="w-4 h-4 text-gray-400 ml-2"></i>` : '';
            // --- FIX: Group icons together ---
            const checkIcon = isCurrent ? '<i data-lucide="check" class="w-5 h-5 text-green-400 ml-2"></i>' : '';
            
            // --- FIX: Show info icon for current user as well ---
            let details = `<p class="font-semibold text-sm flex items-center">${user.name}${parentIcon}${infoIcon}${checkIcon}</p>`;
            // --- END FIX ---

            // --- MUTUAL EXCLUSION LOGIC for display ---
            if (globalDisplayPrefs.userNotes && user.userNotes) {
                details += `<p class="text-xs text-yellow-400 italic mt-0.5">"${user.userNotes}"</p>`;
            } else if (globalDisplayPrefs.adminNotes && user.adminNotes) {
                // Show admin notes only if user notes are not shown
                details += `<p class="text-xs text-cyan-400 italic mt-0.5">Admin: "${user.adminNotes}"</p>`;
            }
            // --- END LOGIC ---
            if (globalDisplayPrefs.location) details += `<p class="text-xs text-gray-400 mt-0.5">${user.location}</p>`;
            if (globalDisplayPrefs.officeCode) details += `<p class="text-xs text-gray-400 mt-0.5">${user.officeCode}</p>`;
            
            const avatar = `<div class="w-8 h-8 mr-3 ${user.color} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0">${user.initials}</div>`;

            return `<div class="flex items-center relative">${avatar}<div>${details}</div></div>`;
        }


        function renderNav() {
            const { mainNavContainer } = getNavElements();
            if (!mainNavContainer) return;

            let navToRender = currentNavType;
            // Platform switching logic removed as per file context
            
            const isOne = (navToRender === 'One'); // This will be false based on currentNavType = 'iQ'
            const navItems = isOne ? `
                <!-- DAT One Nav (currently not shown) -->
            ` : `
                <div id="logoButton" class="self-stretch px-2 mb-6 flex justify-center cursor-pointer">
                    <div class="w-16 h-12 bg-white rounded flex flex-col items-center justify-center text-gray-800 font-bold text-sm">
                        <div>DAT</div>
                        <div class="font-extrabold text-lg">iQ</div>
                    </div>
                </div>
                <div class="self-stretch flex-1 flex flex-col items-start gap-2" id="navContainer">
                    <div data-selected="true" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="home" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Dashboard</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="wrench" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">RateView</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="file-text" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Rateview<br>Multi-Lane</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="clipboard-list" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">RFP Tool</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="clock" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Market<br>Conditions</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="bar-chart-3" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">Benchmark</div></div>
                    <div data-selected="false" class="nav-item w-full cursor-pointer py-2 flex flex-col items-center gap-1"><div class="w-6 h-6 flex items-center justify-center"><i data-lucide="grid" class="icon-default w-6 h-6 stroke-[1.5]"></i></div><div class="w-full text-center text-Web-Text-Navigation-Default text-[11px] leading-tight tracking-tight">More Tools</div></div>
                </div>
            `;
            
            mainNavContainer.innerHTML = navItems + `<div class="self-stretch mt-auto flex flex-col items-center"><div class="py-4"><div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center cursor-pointer"><i data-lucide="help-circle" class="w-6 h-6 stroke-white"></i></div></div><div class="self-stretch border-t border-Web-Border-Container-Primary flex justify-center py-4"><div id="avatarButton" class="w-10 h-10 ${currentUser.color} rounded-full flex items-center justify-center text-white text-sm font-medium cursor-pointer">${currentUser.initials}</div></div></div>`;
            mainNavContainer.className = `h-screen pt-6 bg-Web-Fill-Navigation-Default flex flex-col items-center ${isOne ? 'w-64' : 'w-20'}`;
            
            lucide.createIcons();
        }

        function updateUI() {
            renderNav();
            
            const { currentAccountDisplay, accountList, accountListNoMatch } = getAppElements();
            const { profileNavHeader, profileCurrentAccountDisplay, profileAccountList, profileAccountListNoMatch } = getProfileElements();

            // Update Current Account Displays
            if(currentAccountDisplay) currentAccountDisplay.innerHTML = getUserDisplay(currentUser, true);
            if(profileCurrentAccountDisplay) profileCurrentAccountDisplay.innerHTML = getUserDisplay(currentUser, true);
            
            // Filter and update account list in main pop-out
            const mainFilteredUsers = filterUsers(accountSearchTerm).filter(u => u.id !== currentUser.id);
            if(accountList) {
                if(mainFilteredUsers.length === 0 && accountSearchTerm) {
                    accountList.innerHTML = '';
                    if (accountListNoMatch) accountListNoMatch.classList.remove('hidden');
                } else {
                    if (accountListNoMatch) accountListNoMatch.classList.add('hidden');
                    accountList.innerHTML = mainFilteredUsers.map(u => `<div data-user-id="${u.id}" class="account-item flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white cursor-pointer">${getUserDisplay(u)}</div>`).join('');
                }
            }
            
            // Update profile page nav header
            if (profileNavHeader) {
                profileNavHeader.innerHTML = `<div class="flex items-center">
                    <div class="w-10 h-10 ${currentUser.color} rounded-full flex items-center justify-center text-white text-sm font-medium mr-3 flex-shrink-0">${currentUser.initials}</div>
                    <div>
                        <p class="font-semibold text-base flex items-center">${currentUser.name}${currentUser.isParent ? '<i data-lucide="network" class="w-4 h-4 text-gray-400 ml-2"></i>' : ''}</p>
                        <p class="text-xs text-gray-400">${currentUser.email}</p>
                    </div>
                </div>`;
            }

            // Filter and update profile page account list
            const profileFilteredUsers = filterUsers(profileAccountSearchTerm).filter(u => u.id !== currentUser.id);
            if (profileAccountList) {
                if(profileFilteredUsers.length === 0 && profileAccountSearchTerm) {
                    profileAccountList.innerHTML = '';
                    if (profileAccountListNoMatch) profileAccountListNoMatch.classList.remove('hidden');
                } else {
                    if (profileAccountListNoMatch) profileAccountListNoMatch.classList.add('hidden');
                    profileAccountList.innerHTML = profileFilteredUsers.map(u => `<div data-user-id="${u.id}" class="account-item flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white cursor-pointer">${getUserDisplay(u)}</div>`).join('');
                }
            }
            
            lucide.createIcons();
        }

        
        // Helper to create profile info fields
        function createInfoField(label, value, icon = null) {
            // --- UPDATE: Handle info icon ---
            const iconHTML = icon ? `<i data-lucide="${icon}" class="w-4 h-4 ${icon === 'check' ? 'text-green-500' : 'text-gray-400'} ml-1"></i>` : '';
            return `
                <div>
                    <label class="text-xs text-gray-500">${label}</label>
                    <p class="text-sm text-gray-800 font-medium flex items-center">${value}${iconHTML}</p>
                </div>
            `;
        }
        
        // Helper to create a collapsible card
        function createCollapsibleCard(id, title, content, summary, isCollapsed) {
            const collapsedClass = isCollapsed ? 'collapsed' : '';
            const headerBorderClass = isCollapsed ? 'no-border' : '';
            const collapseIconName = isCollapsed ? 'plus' : 'minus';
            
            let actionButtonHTML = '';
            
            // --- NEW: Special case for Account Switcher ---
            if (id === 'accountSwitcherCard') {
                const editMode = cardStates.accountSwitcherEditMode;
                const editButtonText = editMode ? 'SAVE' : 'EDIT';
                // Show edit button ONLY if card is expanded
                const editButtonVisibility = isCollapsed ? 'hidden' : ''; 
                
                actionButtonHTML = `
                    <div class="flex items-center space-x-4">
                        <button data-action="toggle-edit-account-switcher" class="text-sm font-medium text-blue-600 hover:text-blue-800 ${editButtonVisibility}">
                            ${editButtonText}
                        </button>
                        <i data-lucide="${collapseIconName}" class="w-5 h-5 text-gray-600 collapse-icon"></i>
                    </div>
                `;
            } 
            // --- NEW: Special case for Mobile Notifications ---
            else if (id === 'mobileNotificationsCard') {
                 const editMode = cardStates.mobileNotificationsEditMode;
                const editButtonText = editMode ? 'SAVE' : 'EDIT';
                const editButtonVisibility = isCollapsed ? 'hidden' : ''; 
                
                actionButtonHTML = `
                    <div class="flex items-center space-x-4">
                        <button data-action="toggle-edit-mobile-notifications" class="text-sm font-medium text-blue-600 hover:text-blue-800 ${editButtonVisibility}">
                            ${editButtonText}
                        </button>
                        <i data-lucide="${collapseIconName}" class="w-5 h-5 text-gray-600 collapse-icon"></i>
                    </div>
                `;
            }
            // --- Default for other cards ---
            else {
                actionButtonHTML = `<div class="card-action"><i data-lucide="${collapseIconName}" class="w-5 h-5 text-gray-600 collapse-icon"></i></div>`;
            }
            
            return `
                <div class="profile-card" id="${id}">
                    <div class="profile-card-header ${headerBorderClass}" data-card-id="${id}">
                        <h3 class="text-lg font-semibold text-gray-800">${title}</h3>
                        ${actionButtonHTML}
                    </div>
                    <div class="profile-card-summary ${!isCollapsed ? 'hidden' : ''}">${summary}</div>
                    <div class="profile-card-content ${collapsedClass}">${content}</div>
                </div>
            `;
        }

        function renderUserProfile() {
            // --- FIX: Get container *inside* the function ---
            const { profileCardContainer } = getProfileElements();
            if (!profileCardContainer) {
                console.error("profileCardContainer not found. Cannot render user profile.");
                return; 
            }
            // --- END FIX ---

            // --- NEW: Get edit mode state ---
            const isAccountSwitcherEditMode = cardStates.accountSwitcherEditMode;
            const isMobileNotificationsEditMode = cardStates.mobileNotificationsEditMode;


            // User Details Card
            const userDetailsContent = `
                <div class="bg-blue-50 p-4 rounded-md flex items-start space-x-3 mb-6">
                    <i data-lucide="info" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-gray-700">
                        To request changes to this section, contact <a href="#" class="font-medium text-blue-600 hover:underline">DAT Support</a>.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
                    ${createInfoField('First Name:', currentUser.fName)}
                    ${createInfoField('Last Name:', currentUser.lName)}
                    ${createInfoField('Login Email:', currentUser.email)}
                    ${createInfoField('Contact Phone:', currentUser.phone, 'info')}
                    ${createInfoField('Contact Alternate Phone:', currentUser.altPhone || 'N/A')}
                    ${createInfoField('Contact Email:', currentUser.contactEmail, 'info')}
                </div>
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-800">CHANGE PASSWORD</a>
                    <p class="text-sm text-gray-500 mt-1">We'll send you an email with a link to change your password.</p>
                </div>
            `;
            const userDetailsSummary = `<p class="text-sm text-gray-500">Contains user contact information and password settings.</p>`;

            // --- REWORKED: Account Switcher Display Card ---
            let adminNotesHTML = '';
            let userNotesHTML = '';

            // --- NEW LOGIC: Checkboxes are *always* enabled. Text fields are toggled by isAccountSwitcherEditMode. ---
            
            // Admin Notes
            let adminLabelText = `Admin Notes${(globalDisplayPrefs.adminNotes && currentUser.adminNotes && !isAccountSwitcherEditMode) ? ': ' + currentUser.adminNotes : ''}`;
            adminNotesHTML = `
                <div class="space-y-2">
                    <label class="flex items-center ${globalDisplayPrefs.userNotes ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" data-pref="adminNotes" id="adminNotesCheckbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                               ${globalDisplayPrefs.adminNotes ? 'checked' : ''} ${globalDisplayPrefs.userNotes ? 'disabled' : ''}>
                        <span class="ml-3 text-sm font-medium ${globalDisplayPrefs.userNotes ? 'text-gray-500' : 'text-gray-800'}">
                            ${adminLabelText}
                        </span>
                        <i data-lucide="info" class="w-4 h-4 text-gray-400 ml-2"></i>
                    </label>
                    ${isAccountSwitcherEditMode ? `
                    <div class="m3-text-field ${!globalDisplayPrefs.adminNotes ? 'disabled' : ''} ${currentUser.adminNotes ? 'filled' : ''}">
                        <label for="adminNotesInput">Admin Notes</label>
                        <textarea id="adminNotesInput" class="text-sm" ${!globalDisplayPrefs.adminNotes ? 'disabled' : ''}>${currentUser.adminNotes || ''}</textarea>
                    </div>
                    <p class="text-xs text-gray-500 ml-1">This field is set by account Administrators and is visible to all users.</p>
                    ` : ''}
                </div>
            `;

            // User Notes
            let userLabelText = `User Notes${(globalDisplayPrefs.userNotes && currentUser.userNotes && !isAccountSwitcherEditMode) ? ': ' + currentUser.userNotes : ''}`;
            userNotesHTML = `
                <div class="space-y-2">
                    <label class="flex items-center ${globalDisplayPrefs.adminNotes ? 'opacity-50 cursor-not-allowed' : ''}">
                        <input type="checkbox" data-pref="userNotes" id="userNotesCheckbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                               ${globalDisplayPrefs.userNotes ? 'checked' : ''} ${globalDisplayPrefs.adminNotes ? 'disabled' : ''}>
                        <span class="ml-3 text-sm font-medium ${globalDisplayPrefs.adminNotes ? 'text-gray-500' : 'text-gray-800'}">
                            ${userLabelText}
                        </span>
                         <i data-lucide="info" class="w-4 h-4 text-gray-400 ml-2"></i>
                    </label>
                    ${isAccountSwitcherEditMode ? `
                    <div class="m3-text-field ${!globalDisplayPrefs.userNotes ? 'disabled' : ''} ${currentUser.userNotes ? 'filled' : ''}">
                        <label for="userNotesInput">User Notes</label>
                        <textarea id="userNotesInput" class="text-sm" ${!globalDisplayPrefs.userNotes ? 'disabled' : ''}>${currentUser.userNotes || ''}</textarea>
                    </div>
                    <p class="text-xs text-gray-500 ml-1">This field is set by and only visible to you.</p>
                    ` : ''}
                </div>
            `;
            
            const accountSwitcherContent = `
                <p class="text-sm text-gray-600 mb-6">Select metadata below to display in the Account Switcher pop-out menu.</p>
                <div class="space-y-5">
                    <label class="flex items-center">
                        <input type="checkbox" data-pref="location" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                               ${globalDisplayPrefs.location ? 'checked' : ''}>
                        <span class="ml-3 text-sm font-medium text-gray-800">Account Site</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" data-pref="officeCode" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                               ${globalDisplayPrefs.officeCode ? 'checked' : ''}>
                        <span class="ml-3 text-sm font-medium text-gray-800">Office Code</span>
                    </label>
                    
                    ${adminNotesHTML}
                    ${userNotesHTML}
                </div>
            `;
            // --- END REWORK ---
            
            // Account Switcher Display Card (SUMMARY VIEW)
            const accountSwitcherSummaryContent = buildSummaryList();


            // --- REWORKED: Mobile Notifications Card ---
            const mobileNotificationsContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                    ${isMobileNotificationsEditMode ? `
                        <div class="m3-text-field ${currentUser.mobileNumber ? 'filled' : ''}">
                            <input type="tel" id="mobileNumberInput" value="${currentUser.mobileNumber || ''}">
                            <label for="mobileNumberInput">Mobile Number for DAT One App</label>
                        </div>
                    ` : 
                        createInfoField('Mobile Number for DAT One App', currentUser.mobileNumber || 'N/A', 'info')
                    }
                </div>
            `;
            const mobileNotificationsSummary = `<p class="text-sm text-gray-500">Manage mobile number for DAT One app notifications.</p>`;
            // --- END REWORK ---

            // Authority Level Card
            const authorityLevelContent = `
                <p class="text-sm text-gray-600 mb-6">To change Administrative Level, contact Customer Support at (800) 541-547.</p>
                <div class="flex items-start">
                    <i data-lucide="check" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <span class="text-sm font-medium text-gray-800">Administrative Permission Type</span>
                        <p class="text-sm text-gray-600">${currentUser.adminAuthorityLevel}</p>
                    </div>
                </div>
            `;
            const authorityLevelSummary = `<p class="text-sm text-gray-500">Current Level: <span class="font-medium text-gray-700">${currentUser.adminAuthorityLevel}</span></p>`;


            // Assemble all cards
            profileCardContainer.innerHTML = `
                ${createCollapsibleCard('userDetailsCard', 'User Details', userDetailsContent, userDetailsSummary, cardStates.userDetails)}
                ${createCollapsibleCard('accountSwitcherCard', 'Account Switcher Display', accountSwitcherContent, accountSwitcherSummaryContent, cardStates.accountSwitcher)}
                ${createCollapsibleCard('mobileNotificationsCard', 'Mobile Notifications', mobileNotificationsContent, mobileNotificationsSummary, cardStates.mobileNotifications)}
                ${createCollapsibleCard('authorityLevelCard', 'Authority Level', authorityLevelContent, authorityLevelSummary, cardStates.authorityLevel)}
            `;
            
            lucide.createIcons();
            
            // Add listeners for M3 text fields
            setupM3TextFields();
        }
        
        // --- M3 Text Field Logic ---
        function setupM3TextFields() {
            // --- FIX: Get container *inside* the function ---
            const { profileCardContainer } = getProfileElements();
            if (!profileCardContainer) return;
            // --- END FIX ---
            
            const textFields = profileCardContainer.querySelectorAll('.m3-text-field');
            textFields.forEach(field => {
                const input = field.querySelector('textarea, input'); // Handle both
                if (!input) return;
                
                const updateState = () => {
                    field.classList.toggle('filled', !!input.value);
                };

                input.addEventListener('focus', () => field.classList.add('focused'));
                input.addEventListener('blur', () => {
                    field.classList.remove('focused');
                    updateState();
                });
                input.addEventListener('input', updateState);
                
                // Initial state
                updateState();
            });
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => { 
            updateUI(); 
            lucide.createIcons();
            
            // --- MAIN APP LISTENERS (only need to be added once) ---
            const { mainNavContainer } = getNavElements();
            if (mainNavContainer) {
                mainNavContainer.addEventListener('click', (e) => {
                    const avatarButton = e.target.closest('#avatarButton');
                    const navItem = e.target.closest('.nav-item');

                    if (avatarButton) {
                        e.stopPropagation();
                        const { accountSearchInput } = getAppElements();
                        if (accountSearchInput) accountSearchInput.value = ''; // Clear search on open
                        accountSearchTerm = '';
                        updateUI();
                        const { accountMenu } = getAppElements();
                        if (accountMenu) accountMenu.classList.toggle('hidden');
                    } 
                    else if (navItem && navItem.parentElement.id === 'navContainer') {
                        // Handle nav item selection for iQ style nav
                        const currentSelected = mainNavContainer.querySelector('.nav-item[data-selected="true"]');
                        if (currentSelected) {
                            currentSelected.dataset.selected = 'false';
                        }
                        navItem.dataset.selected = 'true';
                    }
                });
            }

            const { accountList, accountSearchInput, accountInfoLink } = getAppElements();
            if (accountInfoLink) { 
                accountInfoLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    navigateToProfilePage();
                }); 
            }
            if (accountList) {
                accountList.addEventListener('click', (e) => {
                    const accountItem = e.target.closest('.account-item');
                    if(accountItem) {
                        const userId = parseInt(accountItem.dataset.userId);
                        currentUser = users.find(u => u.id === userId) || currentUser;
                        updateUI();
                        const { accountMenu } = getAppElements();
                        if (accountMenu) accountMenu.classList.add('hidden');
                    }
                });
                accountList.addEventListener('mouseover', showTooltip);
                accountList.addEventListener('mouseout', hideTooltip);
            }
            if (accountSearchInput) {
                accountSearchInput.addEventListener('input', (e) => { 
                    accountSearchTerm = e.target.value; 
                    updateUI(); 
                });
            }

            // --- PROFILE PAGE LISTENERS (only need to be added once) ---
            const { 
                profileAccountInfoLink, backToApp, toolsLink, showMoreAccountsButton, 
                profileAccountList, profileAccountSearchInput, profileContent, 
                profileNavLinks, userProfileView 
            } = getProfileElements();

            if (profileAccountInfoLink) {
                profileAccountInfoLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    navigateToProfilePage();
                }); 
            }
            if (backToApp) { 
                backToApp.addEventListener('click', () => { 
                    const { userProfileView, mainAppView } = getAppElements();
                    if(userProfileView) userProfileView.classList.add('hidden'); 
                    if(mainAppView) mainAppView.classList.remove('hidden'); 
                }); 
            }
            if (toolsLink) { 
                toolsLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const { userProfileView, mainAppView } = getAppElements();
                    if(userProfileView) userProfileView.classList.add('hidden'); 
                    if(mainAppView) mainAppView.classList.remove('hidden'); 
                }); 
            }
            if (showMoreAccountsButton) { 
                showMoreAccountsButton.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    const { profileAccountSearchInput, profileAccountMenu } = getProfileElements();
                    if (profileAccountSearchInput) profileAccountSearchInput.value = ''; 
                    profileAccountSearchTerm = ''; 
                    updateUI(); // To refresh the list
                    
                    const rect = showMoreAccountsButton.getBoundingClientRect();
                    if (profileAccountMenu) {
                        profileAccountMenu.style.top = `${rect.top}px`; // Align with the button
                        profileAccountMenu.classList.toggle('hidden');
                    }
                }); 
            }
            if (profileAccountList) {
                profileAccountList.addEventListener('click', (e) => {
                    const accountItem = e.target.closest('.account-item');
                    if(accountItem) {
                        const userId = parseInt(accountItem.dataset.userId);
                        currentUser = users.find(u => u.id === userId) || currentUser;
                        renderUserProfile(); // Rerender profile page with new user data
                        updateUI();
                        const { profileAccountMenu } = getProfileElements();
                        if (profileAccountMenu) profileAccountMenu.classList.add('hidden');
                    }
                });
                profileAccountList.addEventListener('mouseover', showTooltip);
                profileAccountList.addEventListener('mouseout', hideTooltip);
            }
            if (profileAccountSearchInput) {
                profileAccountSearchInput.addEventListener('input', (e) => { 
                    profileAccountSearchTerm = e.target.value; 
                    updateUI(); 
                });
            }
            
            // --- Profile Content Listeners ---
            if (profileContent) {
                profileContent.addEventListener('input', (e) => {
                    const userToUpdate = users.find(u => u.id === currentUser.id);
                    if (!userToUpdate) return;
                    
                    const targetId = e.target.id;
                    const value = e.target.value;

                    if (targetId === 'userNotesInput') {
                        userToUpdate.userNotes = value;
                        currentUser.userNotes = value;
                    } else if (targetId === 'adminNotesInput') { // Removed isAdmin check
                        userToUpdate.adminNotes = value;
                        currentUser.adminNotes = value;
                    } else if (targetId === 'mobileNumberInput') {
                         userToUpdate.mobileNumber = value;
                         currentUser.mobileNumber = value;
                    }
                    
                    const m3Field = e.target.closest('.m3-text-field');
                    if(m3Field) {
                        m3Field.classList.toggle('filled', !!value);
                    }
                });

                profileContent.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox' && e.target.dataset.pref) {
                        const pref = e.target.dataset.pref;
                        const isChecked = e.target.checked;
                        
                        globalDisplayPrefs[pref] = isChecked;

                        if (pref === 'adminNotes' && isChecked) {
                            globalDisplayPrefs.userNotes = false; // Uncheck user notes
                        } else if (pref === 'userNotes' && isChecked) {
                            globalDisplayPrefs.adminNotes = false; // Uncheck admin notes
                        }

                        renderUserProfile(); 
                        updateUI(); 
                    }
                });
                
                profileContent.addEventListener('click', (e) => {
                    const cardHeader = e.target.closest('.profile-card-header');
                    const editButton = e.target.closest('[data-action]'); // Generalize for edit buttons
                    
                    if (editButton) {
                        e.stopPropagation(); 
                        const action = editButton.dataset.action;
                        
                        if(action === 'toggle-edit-account-switcher') {
                            cardStates.accountSwitcherEditMode = !cardStates.accountSwitcherEditMode;
                        } else if (action === 'toggle-edit-mobile-notifications') {
                            cardStates.mobileNotificationsEditMode = !cardStates.mobileNotificationsEditMode;
                        }
                        
                        renderUserProfile();
                        return; 
                    }

                    if (cardHeader) {
                        const cardId = cardHeader.dataset.cardId;
                        if (!cardId) return; 
                        
                        const collapseIcon = e.target.closest('.collapse-icon');
                        // For cards with edit buttons, only collapse if the collapse icon is clicked
                        if (cardId === 'accountSwitcherCard' || cardId === 'mobileNotificationsCard') {
                            if (!collapseIcon) {
                                return; // Click was not on collapse icon, so do nothing
                            }
                        }
                        
                        const cardStateKey = cardId.replace('Card', ''); 
                        if (cardStates[cardStateKey] === undefined) return; 
                        
                        const isCollapsing = !cardStates[cardStateKey]; 
                        cardStates[cardStateKey] = isCollapsing;

                        const card = cardHeader.closest('.profile-card'); 
                        const content = card.querySelector('.profile-card-content');
                        const summary = card.querySelector('.profile-card-summary');
                        
                        if (content && summary) {
                            
                            if (isCollapsing && card && card.id === 'accountSwitcherCard') {
                                summary.innerHTML = buildSummaryList();
                                lucide.createIcons(); 
                                cardStates.accountSwitcherEditMode = false; // Reset edit mode on collapse
                            }
                            if (isCollapsing && card && card.id === 'mobileNotificationsCard') {
                                cardStates.mobileNotificationsEditMode = false; // Reset edit mode on collapse
                            }

                            content.classList.toggle('collapsed', isCollapsing);
                            summary.classList.toggle('hidden', !isCollapsing);
                            cardHeader.classList.toggle('no-border', isCollapsing && !summary.innerHTML.trim()); 
                            
                            const icon = cardHeader.querySelector('.collapse-icon');
                            if (icon) { 
                                icon.setAttribute('data-lucide', isCollapsing ? 'plus' : 'minus');
                            }
                            
                            // Handle visibility of edit buttons on collapse/expand
                            const editBtn = cardHeader.querySelector('[data-action]');
                            if (editBtn) {
                                // Find the button itself, not the container
                                const btn = editBtn.closest('button');
                                if (btn) {
                                    btn.classList.toggle('hidden', isCollapsing);
                                }
                                if (isCollapsing) { // If collapsing, reset edit mode
                                    if(cardId === 'accountSwitcherCard') cardStates.accountSwitcherEditMode = false;
                                    if(cardId === 'mobileNotificationsCard') cardStates.mobileNotificationsEditMode = false;
                                } else { // If expanding
                                    // We must re-render to get the correct button state
                                    renderUserProfile();
                                }
                            }
                            lucide.createIcons();
                        }
                    }
                });
            }
            
            // --- Profile Nav Link Listener ---
            if (profileNavLinks) {
                profileNavLinks.addEventListener('click', (e) => {
                    const profileNavItem = e.target.closest('.profile-nav-item');
                    if (profileNavItem) {
                        e.preventDefault();
                        
                        const currentActive = profileNavLinks.querySelector('.active');
                        if (currentActive) currentActive.classList.remove('active');
                        profileNavItem.classList.add('active');

                        const linkText = profileNavItem.innerText.trim();
                        const iconName = profileNavItem.dataset.iconName;
                        
                        const { profileContent } = getProfileElements(); // Get profileContent
                        if (!profileContent) return;

                        if (linkText !== 'User Profile') {
                            if (!iconName) { 
                                console.error("Could not find icon name for nav item:", profileNavItem);
                                return;
                            }
                            profileContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md h-full flex flex-col items-center justify-center text-center">
                                <i data-lucide="${iconName}" class="w-16 h-16 text-gray-300 mb-4"></i>
                                <h1 class="text-2xl font-bold text-gray-800">${linkText}</h1>
                                <p class="mt-2 text-gray-600 max-w-md">This is a placeholder page for the "${linkText}" section. All of the relevant tools and content would be displayed here.</p>
                            </div>`;
                            lucide.createIcons();
                        } else {
                            profileContent.innerHTML = `<div class="max-w-4xl mx-auto">
                                <h1 class="text-2xl font-bold text-gray-900 mb-1">User Profile</h1>
                                <p class="text-sm text-gray-500 mb-6" id="lastUpdatedText">Last Updated: Oct 18, 2025, by DAT</p>
                                <div id="profileCardContainer" class="space-y-6">
                                    <!-- Profile cards will be rendered here by JS -->
                                </div>
                            </div>`;
                            renderUserProfile(); // Re-render the main profile content
                        }
                    }
                });
            }

            // --- Tooltip & Global Click Listeners ---
            const { currentAccountDisplay: appCurrentAcc } = getAppElements();
            const { profileCurrentAccountDisplay: profCurrentAcc } = getProfileElements();
            if(appCurrentAcc) {
                appCurrentAcc.addEventListener('mouseover', showTooltip);
                appCurrentAcc.addEventListener('mouseout', hideTooltip);
            }
            if(profCurrentAcc) {
                profCurrentAcc.addEventListener('mouseover', showTooltip);
                profCurrentAcc.addEventListener('mouseout', hideTooltip);
            }

            window.addEventListener('click', (e) => {
                const { accountMenu } = getAppElements();
                const { profileAccountMenu } = getProfileElements();

                if (accountMenu && !accountMenu.contains(e.target) && !e.target.closest('#avatarButton')) { 
                    accountMenu.classList.add('hidden'); 
                }
                if (profileAccountMenu && !profileAccountMenu.contains(e.target) && !e.target.closest('#showMoreAccountsButton')) {
                    profileAccountMenu.classList.add('hidden');
                }
            });

        }); // End DOMContentLoaded
        
        
        // --- NAVIGATION BUG FIX ---
        function navigateToProfilePage() {
             const { mainAppView, userProfileView, accountMenu } = getAppElements();
             const { profileAccountMenu, profileNavLinks, profileContent } = getProfileElements();

             if(mainAppView) mainAppView.classList.add('hidden');
             if(userProfileView) userProfileView.classList.remove('hidden');
             if(accountMenu) accountMenu.classList.add('hidden');
             if(profileAccountMenu) profileAccountMenu.classList.add('hidden');

            if (profileNavLinks) {
                const currentActive = profileNavLinks.querySelector('.active');
                if (currentActive) currentActive.classList.remove('active');
                
                const userProfileLink = profileNavLinks.querySelector('a[data-icon-name="user"]');
                if (userProfileLink) userProfileLink.classList.add('active');
            }
            
            if (profileContent) {
                profileContent.innerHTML = `<div class="max-w-4xl mx-auto">
                    <h1 class="text-2xl font-bold text-gray-900 mb-1">User Profile</h1>
                    <p class="text-sm text-gray-500 mb-6" id="lastUpdatedText">Last Updated: Oct 18, 2025, by DAT</p>
                    <div id="profileCardContainer" class="space-y-6">
                        <!-- Profile cards will be rendered here by JS -->
                    </div>
                </div>`;
                renderUserProfile(); // Render the user profile content
            }
        }
        // --- END NAVIGATION BUG FIX ---

        // --- Tooltip Logic ---
        function showTooltip(e) {
            const target = e.target.closest('.account-info-icon');
            if (!target) return;

            const userId = parseInt(target.dataset.userId);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const userNotesHTML = (user.userNotes && globalDisplayPrefs.userNotes) ? `<div class="mt-2 pt-2 border-t border-gray-600">
                <h5 class="font-bold text-gray-300">User Notes</h5>
                <p class="italic text-yellow-300">"${user.userNotes}"</p>
            </div>` : '';

            const adminNotesHTML = (user.adminNotes && globalDisplayPrefs.adminNotes) ? `<div class="mt-2 pt-2 border-t border-gray-600">
                <h5 class="font-bold text-gray-300">Admin Notes</h5>
                <p class="text-cyan-300">${user.adminNotes}</p>
            </div>` : '';
            
            // --- NEW: Capabilities ---
            const capabilitiesHTML = (user.capabilities && user.capabilities.length > 0) ? `
                <p><span class="font-semibold text-gray-400">Capabilities:</span> ${user.capabilities.join(', ')}</p>
            ` : '';

            // Populate tooltip
            accountTooltip.innerHTML = `
                <div class="space-y-1">
                    <h4 class="font-bold text-base mb-2 border-b border-gray-600 pb-1">${user.company}</h4>
                    
                    <h5 class="font-bold text-gray-300">User Details</h5>
                    <p><span class="font-semibold text-gray-400">Full Name:</span> ${user.fName} ${user.lName}</p>
                    <p><span class="font-semibold text-gray-400">Login Email:</span> ${user.email}</p>
                    <p><span class="font-semibold text-gray-400">Contact Phone:</span> ${user.phone}</p>
                    <p><span class="font-semibold text-gray-400">Contact Email:</span> ${user.contactEmail}</p>
                    <p><span class="font-semibold text-gray-400">Admin Level:</span> ${user.adminAuthorityLevel}</p>

                    <div class="mt-2 pt-2 border-t border-gray-600">
                        <h5 class="font-bold text-gray-300">Account Details</h5>
                        <p><span class="font-semibold text-gray-400">Location:</span> ${user.location}</p>
                        <p><span class="font-semibold text-gray-400">Office:</span> ${user.officeCode}</p>
                        <p><span class="font-semibold text-gray-400">MC/DOT:</span> ${user.mcDotNumber}</p>
                        <p><span class="font-semibold text-gray-400">Subscription:</span> ${user.subscriptions}</p>
                        ${capabilitiesHTML}
                    </div>

                    ${userNotesHTML}
                    ${adminNotesHTML}
                </div>
            `;

            // Position tooltip
            const rect = target.getBoundingClientRect();
            accountTooltip.style.left = `${rect.right + 10}px`;
            
            // Adjust vertical position to prevent overflow
            const tooltipHeight = accountTooltip.offsetHeight;
            const windowHeight = window.innerHeight;
            let topPosition = rect.top;

            if (topPosition + tooltipHeight > windowHeight - 20) { // 20px buffer
                topPosition = windowHeight - tooltipHeight - 20;
            }
            if (topPosition < 20) {
                topPosition = 20;
            }

            accountTooltip.style.top = `${topPosition}px`;
            accountTooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            accountTooltip.classList.add('hidden');
        }
        
    </script>
</body>
</html>
